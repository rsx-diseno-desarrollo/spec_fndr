<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SpecFinder BETA</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" href="img/favicon.ico">
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- PWA Manifest END -->
<!-- Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js?v=13')
        .then(reg => console.log('Service Worker registrado'))
        .catch(err => console.log('Error al registrar el Service Worker:', err));
    });
  }
</script>
<!-- Service Worker END -->
</head>
<body>
<header>
  <!-- Menu -->
  <button class="boton-menu"><img src="img/menu-icon.png"/></button>
<nav class="menu">
  <ul>
    <li><a href="#" data-section="seccion-producto">Producto</a></li>
    <li><a href="#" data-section="seccion-empaque">Empaque</a></li>
    <li><a href="#" data-section="seccion-componentes">Componentes</a></li>
  </ul>
</nav>
<!-- Menu END -->
</header>
<!-- Menu script -->
<script>
  const botonMenu = document.querySelector('.boton-menu');
  const menu = document.querySelector('.menu');

  botonMenu.addEventListener('click', () => {
    menu.classList.toggle('abierto');
  });
</script>
<!-- Menu script END -->
  
<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<!-- SheetJS END -->

  <!-- SECCIONES -->
  <div class="header">
    <img src="img/spec-finder-logo.jpg"/>
    <h2>CONSULTA DE ESPECIFICACIONES</h2><br>
  </div>

  <!-- SECCION PRODUCTO -->
  <div id="seccion-producto" class="seccion activa">
  <h3>Especificaciones de producto</h3>
    <div class="buscador">
      <input type="text" id="parte" placeholder="No. de parte sin guiones">
      <select id="cliente">
        <option value="">-- Selecciona cliente --</option>
      </select>
      <select id="nombre">
        <option value="">-- Selecciona nombre --</option>
      </select>
    </div>
      <div id="results-prod"></div>
  </div>
  <!-- SECCION PRODUCTO END -->
  
  <!-- SECCION EMPAQUE -->
  <div id="seccion-empaque" class="seccion">
    <h3>Especificaciones de Empaque</h3>
    <p>Aquí podrás buscar specs de empaque :D</p>
  </div>
  <!-- SECCION EMPAQUE END -->

  <!-- SECCION COMPONENETES -->
  
<!-- SECCION COMPONENTES -->
<div id="seccion-componentes" class="seccion">
      <h3>Especificaciones de Componentes</h3>
    
      <!-- Buscador -->
      <div class="buscador" style="position:relative;">
        <input type="text" id="codigoComp" placeholder="Código sin guiones" autocomplete="off">
        <div id="autocomplete-list" class="autocomplete-items"></div>
    
        <select id="tipoComp">
          <option value="">-- Selecciona tipo --</option>
        </select>
    
        <!-- Botón Buscar debajo del selector -->
        <button id="btnBuscarComp" class="btn btn-primario">Buscar</button>
      </div>
    
      <!-- Panel de cotas y dibujo (aparece debajo del buscador) -->
      <div id="panel-cotas" class="panel-cotas" style="margin-top:16px;">
        <h4>Cotas del componente seleccionado</h4>
    
        <!-- SVG interactivo del tornillo -->
        <svg id="svg-tornillo" width="400" height="200" viewBox="0 0 400 200" style="border:1px solid #ccc;">
          <!-- Tornillo base -->
          <rect x="50" y="80" width="250" height="40" fill="#ccc" stroke="#000"/>
          <!-- Cabeza -->
          <rect x="30" y="70" width="20" height="60" fill="#999" stroke="#000"/>
          <!-- Etiquetas dinámicas -->
          <text id="cota-A" x="200" y="140" font-size="14" fill="blue">A: -</text>
          <text id="cota-B" x="280" y="70" font-size="14" fill="blue">B: -</text>
          <text id="cota-C" x="40" y="50" font-size="14" fill="blue">C: -</text>
          <text id="cota-D" x="40" y="160" font-size="14" fill="blue">D: -</text>
          <text id="cota-R" x="300" y="160" font-size="14" fill="blue">Radio: -</text>
        </svg>
    
        <!-- Tabla/Lista de cotas textual -->
        <div id="cotas-texto" style="margin-top:10px;">
          <p><strong>A:</strong> <span id="txt-A">-</span></p>
          <p><strong>B:</strong> <span id="txt-B">-</span></p>
          <p><strong>C:</strong> <span id="txt-C">-</span></p>
          <p><strong>D:</strong> <span id="txt-D">-</span></p>
          <p><strong>Radio:</strong> <span id="txt-R">-</span></p>
          <!-- (Opcional) Enlace al RMS del componente activo -->
          <p id="rms-link" style="margin-top:6px;"></p>
        </div>
      </div>
</div>

  <!-- SECCION COMPONENETES END -->
  
<!-- Cargar excel -->
  <script>
  async function cargarExcel() {
const url = "specs.xlsx";
try {
 const response = await fetch(url);
 const arrayBuffer = await response.arrayBuffer();
 const workbook = XLSX.read(arrayBuffer, { type: 'array' });

 const allData = {};
 workbook.SheetNames.forEach(sheetName => {
   allData[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
 });

 window.data = allData;
 console.log("Datos cargados:", allData);

 // --- PRODUCTOS ---
 const specs = allData.prod;
 const clienteSelect = document.getElementById("cliente");
 const nombreSelect = document.getElementById("nombre");

 const clientes = [...new Set(specs.map(s => s["CLIENTE"]))];
 const nombres = [...new Set(specs.map(s => s["NOMBRE"]))];

 clientes.forEach(c => {
   const opt = document.createElement("option");
   opt.value = c;
   opt.textContent = c;
   clienteSelect.appendChild(opt);
 });

 nombres.forEach(n => {
   const opt = document.createElement("option");
   opt.value = n;
   opt.textContent = n;
   nombreSelect.appendChild(opt);
 });

 function buscar() {
   const parte = document.getElementById("parte").value.toLowerCase();
   const cliente = clienteSelect.value.toLowerCase();
   const nombre = nombreSelect.value.toLowerCase();

   const filtered = specs.filter(spec => {
     const partesArray = String(spec["NO. PARTE"] || "")
       .split(",")
       .map(p => p.trim().toLowerCase());

     return (
       (parte === "" || partesArray.some(p => p.includes(parte))) &&
       (cliente === "" || spec["CLIENTE"].toLowerCase() === cliente) &&
       (nombre === "" || spec["NOMBRE"].toLowerCase() === nombre)
     );
   });

   const resultsDiv = document.getElementById("results-prod");
   resultsDiv.innerHTML = "";
   filtered.forEach(spec => {
     resultsDiv.innerHTML += `
       <div class="spec">
         <strong>${spec["CLIENTE"]}</strong><br>
         Código: ${spec["CODIGO"]}<br>
         No. de Parte: ${spec["NO. PARTE"]}<br>
         Nombre: ${spec["NOMBRE"]}<br>
         <a href="${spec["LIGA"]}" target="_blank">Abrir RMS</a>
       </div>
     `;
   });
 }

 document.getElementById("parte").addEventListener("input", buscar);
 clienteSelect.addEventListener("change", buscar);
 nombreSelect.addEventListener("change", buscar);
// --- PRODUCTOS END ---

// ====== COMPONENTES (nuevo) ======
function inicializarComponentes(componentes = []) {
  const tipoSelect = document.getElementById("tipoComp");
  const autocompleteList = document.getElementById("autocomplete-list");
  const inputCodigo = document.getElementById("codigoComp");
  const btnBuscar = document.getElementById("btnBuscarComp");

  if (!tipoSelect || !inputCodigo || !btnBuscar) return;

  // Popular tipos
  const tipos = [...new Set(componentes.map(c => c["TIPO DE COMPONENTE"]).filter(Boolean))];
  tipos.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t;
    opt.textContent = t;
    tipoSelect.appendChild(opt);
  });

  // Autocompletado (solo lista sugerencias; no renderiza tarjetas)
  inputCodigo.addEventListener("input", function () {
    const val = this.value.toLowerCase();
    if (!autocompleteList) return;
    autocompleteList.innerHTML = "";
    if (!val) return;

    const sugerencias = componentes
      .map(c => String(c["CODIGO COMPONENTES"] || ""))
      .filter(codigo => codigo.toLowerCase().includes(val));

    sugerencias.slice(0, 10).forEach(s => {
      const div = document.createElement("div");
      div.textContent = s;
      div.addEventListener("click", () => {
        inputCodigo.value = s;
        autocompleteList.innerHTML = "";
      });
      autocompleteList.appendChild(div);
    });
  });

  // Cerrar autocompletado al hacer click fuera
  document.addEventListener("click", (e) => {
    const clickedInside =
      e.target === inputCodigo ||
      e.target === autocompleteList ||
      e.target?.parentElement === autocompleteList;
    if (!clickedInside && autocompleteList) autocompleteList.innerHTML = "";
  });

  // Botón Buscar: aplica filtro y muestra cotas + SVG abajo
  btnBuscar.addEventListener("click", () => {
    mostrarCotasSeleccion(componentes);
  });

  // También disparar búsqueda al cambiar tipo (opcional)
  tipoSelect.addEventListener("change", () => {
    // Si quieres que cambie en tiempo real al cambiar el tipo, descomenta:
    // mostrarCotasSeleccion(componentes);
  });
}

// Aplica filtros y muestra cotas y SVG debajo del buscador
function mostrarCotasSeleccion(componentes) {
  const codigo = (document.getElementById("codigoComp")?.value || "").toLowerCase();
  const tipo = (document.getElementById("tipoComp")?.value || "").toLowerCase();

  // Filtrar
  const matches = componentes.filter(comp => {
    const codigosArray = String(comp["CODIGO COMPONENTES"] || "")
      .split(",")
      .map(c => c.trim().toLowerCase());
    const pasaCodigo = (codigo === "" || codigosArray.some(c => c.includes(codigo)));
    const pasaTipo = (tipo === "" || String(comp["TIPO DE COMPONENTE"] || "").toLowerCase() === tipo);
    return pasaCodigo && pasaTipo;
  });

  if (matches.length === 0) {
    // Limpiar panel si no hay resultados
    actualizarCotasYSvg(null);
    const rms = document.getElementById("rms-link");
    if (rms) rms.innerHTML = `<span style="color:#c62828;">Sin resultados con el filtro actual.</span>`;
    return;
  }

  // Priorizar coincidencia exacta del código (si se escribió)
  let compSeleccionado = matches[0];
  if (codigo) {
    const exact = matches.find(m =>
      String(m["CODIGO COMPONENTES"] || "")
        .toLowerCase()
        .split(",")
        .map(s => s.trim())
        .includes(codigo)
    );
    if (exact) compSeleccionado = exact;
  }

  // Actualizar cotas y SVG
  actualizarCotasYSvg(compSeleccionado);
}

// Actualiza textos del SVG y cotas textuales
function actualizarCotasYSvg(comp) {
  const setTxt = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt; };

  if (!comp) {
    setTxt("cota-A", "A: -"); setTxt("txt-A", "-");
    setTxt("cota-B", "B: -"); setTxt("txt-B", "-");
    setTxt("cota-C", "C: -"); setTxt("txt-C", "-");
    setTxt("cota-D", "D: -"); setTxt("txt-D", "-");
    setTxt("cota-R", "Radio: -"); setTxt("txt-R", "-");
    const rms = document.getElementById("rms-link");
    if (rms) rms.innerHTML = "";
    return;
  }

  const A = comp["A"] ?? "-";
  const B = comp["B"] ?? "-";
  const C = comp["C"] ?? "-";
  const D = comp["D"] ?? "-";
  const R = comp["RADIO"] ?? "-";

  // SVG
  setTxt("cota-A", `A: ${A}`);
  setTxt("cota-B", `B: ${B}`);
  setTxt("cota-C", `C: ${C}`);
  setTxt("cota-D", `D: ${D}`);
  setTxt("cota-R", `Radio: ${R}`);

  // Texto
  setTxt("txt-A", `${A}`);
  setTxt("txt-B", `${B}`);
  setTxt("txt-C", `${C}`);
  setTxt("txt-D", `${D}`);
  setTxt("txt-R", `${R}`);

  // Link RMS opcional
  const rms = document.getElementById("rms-link");
  if (rms) {
    const liga = comp["LIGA"] || "";
    rms.innerHTML = liga ? `<a href="${liga}">Abrir RMS</a>` : "";
  }
}

// ====== COMPONENTES (nuevo) END ======
  
} catch (error) {
 console.error("Error al cargar el Excel:", error);
}
}
cargarExcel();
    
  document.querySelectorAll('.menu a').forEach(link => {
  link.addEventListener('click', e => {
    e.preventDefault();
    const target = link.dataset.section;
    document.querySelectorAll('.seccion').forEach(sec => sec.classList.remove('activa'));
    document.getElementById(target).classList.add('activa');
    localStorage.setItem('seccionActiva', target); // Guardar sección
    menu.classList.remove('abierto'); // Cerrar menú
  });
});

  // Restaurar sección activa al cargar
  window.addEventListener('load', () => {
  const ultimaSeccion = localStorage.getItem('seccionActiva');
  if (ultimaSeccion) {
    document.querySelectorAll('.seccion').forEach(sec => sec.classList.remove('activa'));
    document.getElementById(ultimaSeccion).classList.add('activa');
  }
});

</script>
</body>
</html>
